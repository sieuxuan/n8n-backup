{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Switch1": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "WF download videos",
            "type": "main",
            "index": 0
          }
        ],
        [],
        []
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "G·ª≠i tin nh·∫Øn5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WF download videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "G·ª≠i tin nh·∫Øn1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF ERROR": {
      "main": [
        []
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Update row in sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "G·ª≠i tin nh·∫Øn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet": {
      "main": [
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "G·ª≠i tin nh·∫Øn2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF ERROR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "G·ª≠i tin nh·∫Øn4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "WF download videos": {
      "main": [
        [
          {
            "node": "G·ª≠i tin nh·∫Øn6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Zalo Event Trigger": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet2": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "G·ª≠i tin nh·∫Øn3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet3": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Update row in sheet1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "G·ª≠i tin nh·∫Øn7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet1": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "G·ª≠i tin nh·∫Øn8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF ERROR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "Switch4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch4": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get row(s) in sheet3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-26T08:09:23.434Z",
  "id": "012mOIo2ynbtnnOc",
  "isArchived": true,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "IT HELPDESK",
  "nodes": [
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data.msgType }}",
                    "rightValue": "webchat",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "df7020ce-6c12-4446-b5c0-8f6c24e62127"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cc6c6754-b520-480e-9e3f-14363f31167d",
                    "leftValue": "={{ $json.data.msgType }}",
                    "rightValue": "chat.photo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9f8f970d-9265-4e17-a2fb-3e8031dea125",
                    "leftValue": "={{ $json.data.msgType }}",
                    "rightValue": "chat.recommended",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "30236288-2ea4-4b61-ac47-7ab3bc2555a8",
                    "leftValue": "={{ $json.data.msgType }}",
                    "rightValue": "chat.video.msg",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f6d6afe4-fa38-424e-a6c5-62666ac36f40",
                    "leftValue": "={{ $json.data.msgType }}",
                    "rightValue": "share.file",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -592,
        688
      ],
      "id": "de5e1cf9-5b51-45d8-b80e-651e72940eea",
      "name": "Switch1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data.content.toLowerCase().includes(\"check\") || $json.data.content.toLowerCase().includes(\"check\") }}",
                    "rightValue": "=",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "e517034a-2dd0-42cc-9a18-c40fd2db382c"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cdbbe62c-a93b-44ec-91de-1c91797507df",
                    "leftValue": "={{ $json.data.content.toLowerCase() }}",
                    "rightValue": "done",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6ca65423-b222-4ee0-9280-c8c27f8c715e",
                    "leftValue": "={{ $json.data.content.toLowerCase() }}",
                    "rightValue": "id group",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9b48cff-6542-49c8-923b-ec6598aafc3e",
                    "leftValue": "={{ $json.data.content.toLowerCase().includes(\"@it bot\") || $json.data.content.toLowerCase().includes(\"xb\") }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8b9c7841-7975-4743-912d-a74179e06a15",
                    "leftValue": "={{ $json.data.content.toLowerCase() }}",
                    "rightValue": "download",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -368,
        544
      ],
      "id": "433dac23-96af-4302-a959-3d35e0e2a5d5",
      "name": "Switch",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "/***** R√öT G·ªåN TH√îNG ƒêI·ªÜP *****/\nfunction trimText(s, max = 150) {\n  if (!s) return \"\";\n  let t = String(s).replace(/\\s+/g, \" \").trim();\n  if (t.length <= max) return t;\n  return t.slice(0, max - 1) + \"‚Ä¶\";\n}\n\nconst pendingItems = items.filter(item => {\n  const status = (item.json.Status || item.json[\"Status\"] || \"\").toLowerCase();\n  return status !== \"done\";\n});\n\n// Header: ch·ªâ hi·ªÉn th·ªã s·ªë l∆∞·ª£ng ID pending\nconst header = pendingItems.length\n  ? `üîî C√≥ ${pendingItems.length} y√™u c·∫ßu pending`\n  : \"‚úÖ Kh√¥ng c√≥ y√™u c·∫ßu ch∆∞a ho√†n th√†nh.\";\n\n// Chi ti·∫øt ng·∫Øn g·ªçn t·ª´ng ID (m·ªói ID 1 d√≤ng + 1 d√≤ng tr·ªëng)\nconst details = pendingItems.map(item => {\n  const data = item.json;\n\n  const id          = data.ID || \"Kh√¥ng c√≥ ID\";\n  const department  = (data[\"B·ªò PH·∫¨N\"] ?? data[\"B·ªò PH·∫¨N \"] ?? data[\"Department\"] ?? \"\").toString().trim();\n  const creator     = (data[\"T√äN B·∫†N L√Ä\"] || data[\"Ng∆∞·ªùi t·∫°o\"] || \"\").toString().trim();\n  const category    = (data[\"PH√ÇN LO·∫†I\"] ?? data[\"PH√ÇN LO·∫†I \"] ?? data[\"Issues Category\"] ?? \"\").toString().trim();\n  const description = data.Description || data[\"Description\"] || \"\";\n  const timestamp   = data.Timestamp || data[\"Timestamp\"] || \"\";\n\n  const shortDesc = trimText(\n    (category ? `[${category}] ` : \"\") + (description ? description : \"\"),\n    150\n  );\n\n  return `‚Ä¢ ${id} | ${timestamp} | ${creator}${department ? \" (\" + department + \")\" : \"\"} | ${shortDesc}`;\n});\n\n// Th√™m d√≤ng tr·ªëng gi·ªØa c√°c ID\nconst body = pendingItems.length\n  ? `${header}\\n\\n${details.join(\"\\n\\n\")}`\n  : header;\n\nconst threadId = $('Switch').first().json.threadId;\nconst type     = $('Switch').first().json.type;\n\nreturn [{\n  json: {\n    message: body.replace(/(?:\\r\\n|\\r|\\n)+$/g, ''),\n    threadId,\n    type\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        -224
      ],
      "id": "aec914ef-d4b7-438e-9509-8a55dbd93700",
      "name": "Code"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg",
          "mode": "list",
          "cachedResultName": "IT HELP DESK",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        208,
        -224
      ],
      "id": "e8273c40-cb53-43fd-92e3-61adf9244bb3",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "X1UBt5tMcyjhPYqy",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y n·ªôi dung tin nh·∫Øn v√† uid ng∆∞·ªùi g·ª≠i\nconst message = $json.data?.content || '';\nconst uidFrom = $json.data?.uidFrom || '';\n\n// T√°ch t·ª´ ƒë·ªÉ l·∫•y status cu·ªëi c√¢u\nconst parts = message.trim().split(/\\s+/);\n\n// ‚úÖ B·∫Øt ƒë√∫ng chu·ªói ID-***** (b·∫Øt ƒë·∫ßu b·∫±ng \"ID-\")\nconst idMatch = message.match(/\\bID-[A-Za-z0-9_-]+\\b/i);\nconst ID = idMatch ? idMatch[0].toUpperCase() : 'unknown';\n\n// ‚úÖ Gi·∫£ s·ª≠ status lu√¥n n·∫±m ·ªü cu·ªëi chu·ªói, lo·∫°i d·∫•u c√¢u n·∫øu c√≥\nconst statusRaw = parts[parts.length - 1] || '';\nconst cleanedStatus = statusRaw.replace(/[.,;:!?]+$/g, ''); // b·ªè d·∫•u c√¢u cu·ªëi\nconst doneSynonyms = ['done', 'xong'];\nlet status = 'unknown';\nif (cleanedStatus) {\n  const normalized = cleanedStatus.toLowerCase();\n  status = doneSynonyms.includes(normalized)\n    ? 'Done'\n    : normalized.charAt(0).toUpperCase() + normalized.slice(1);\n}\n\nconst theardID = $json.threadId;   // gi·ªØ nguy√™n t√™n bi·∫øn nh∆∞ b·∫°n ƒëang d√πng\nconst type = $json.type;\n\n// Danh s√°ch t√™n cho ph√©p\nconst allowedNames = [\"T√πng\", \"Xu√¢n\", \"Ph∆∞∆°ng\"];\n\n// üîé T√¨m t√™n trong message (lo·∫°i k√Ω t·ª± l·∫° ·ªü ƒë·∫ßu/cu·ªëi t·ª´ tr∆∞·ªõc khi so)\nlet nameFromMessage = null;\nfor (const w of parts) {\n  const word = w.replace(/^[^A-Za-z√Ä-·ªπ]+|[^A-Za-z√Ä-·ªπ]+$/gi, '');\n  if (allowedNames.includes(word)) {\n    nameFromMessage = word;\n    break;\n  }\n}\n\n// Map uidFrom ‚Üí name (fallback)\nconst nameMap = {\n  \"9150902062671965622\": \"T√πng\",\n  \"2091898082743203663\": \"Xu√¢n\",\n  \"3266757489410168093\": \"Ph∆∞∆°ng\"\n};\n\nconst name = nameFromMessage || nameMap[uidFrom] || 'unknown';\n\n// Tr·∫£ k·∫øt qu·∫£\nreturn [\n  {\n    json: {\n      ID,\n      status,\n      name,\n      theardID,\n      type\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        160
      ],
      "id": "df74ea19-4d08-4b68-a9d5-c55fa5b45674",
      "name": "Code2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg",
          "mode": "list",
          "cachedResultName": "IT HELP DESK",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "ID",
              "lookupValue": "={{ $json.ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        656,
        160
      ],
      "id": "41d0cd47-746b-44f2-ad2d-ffae3f529bdb",
      "name": "Get row(s) in sheet1",
      "alwaysOutputData": true,
      "notesInFlow": false,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "X1UBt5tMcyjhPYqy",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "78267e7c-df06-46b4-90cd-dabb35110b16",
              "name": "ID",
              "value": "={{ $json.ID }}",
              "type": "string"
            },
            {
              "id": "189ccc3c-0f9c-49aa-b0b9-505c1ca8b12e",
              "name": "ID_Status",
              "value": "={{ $json.Status }}",
              "type": "string"
            },
            {
              "id": "a6f1e968-73d6-4c35-a861-c76eabfa6ad1",
              "name": "Chat_status",
              "value": "={{ \n  $if($(\"Code2\").isExecuted, $(\"Code2\").item.json.status, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.status, \"\")\n  ) \n}}",
              "type": "string"
            },
            {
              "id": "cbd6f9b1-0124-4e3a-812e-74967830798c",
              "name": "name",
              "value": "={{ \n  $if($(\"Code2\").isExecuted, $(\"Code2\").item.json.name, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.name, \"\")\n  ) \n}}",
              "type": "string"
            },
            {
              "id": "2b8e5ad5-51bb-48d9-baca-f84010fdfa66",
              "name": "Finish time",
              "value": "={{ (() => { const d = new Date(new Date().toLocaleString(\"en-US\",{ timeZone: \"Asia/Ho_Chi_Minh\"})); const p=n=>n.toString().padStart(2,'0'); return `${p(d.getMonth()+1)}/${p(d.getDate())}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}` })() }}",
              "type": "string"
            },
            {
              "id": "426e14d3-9f41-4dc8-8f82-886d2601ebd5",
              "name": "Timestamp",
              "value": "={{ $json.Timestamp }}",
              "type": "string"
            },
            {
              "id": "a00e4dd4-1a9a-433f-8ef5-9b03da19e1cc",
              "name": "Process time",
              "value": "={{\n(() => {\n  // ===== C·∫§U H√åNH =====\n  const TZ = 'Asia/Ho_Chi_Minh';      // M√∫i gi·ªù Vi·ªát Nam\n  const WS = { h: 8,  m: 15 };        // Gi·ªù b·∫Øt ƒë·∫ßu l√†m vi·ªác: 08:15\n  const WE = { h: 17, m: 30 };        // Gi·ªù k·∫øt th√∫c l√†m vi·ªác: 17:30\n  const LS = { h: 11, m: 45 };        // B·∫Øt ƒë·∫ßu ngh·ªâ tr∆∞a: 11:45\n  const LE = { h: 13, m: 0  };        // K·∫øt th√∫c ngh·ªâ tr∆∞a: 13:00\n  const SKIP_SUNDAY = true;           // B·ªè qua Ch·ªß nh·∫≠t\n\n  // ===== L·∫§Y TH·ªúI GIAN K·∫æT TH√öC (HI·ªÜN T·∫†I THEO GI·ªú VN) =====\n  const finishStr = (() => {\n    const d = new Date(new Date().toLocaleString(\"en-US\", { timeZone: TZ }));\n    const p = n => n.toString().padStart(2,'0');\n    return `${p(d.getMonth()+1)}/${p(d.getDate())}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;\n  })();\n\n  // ===== H√ÄM PARSE STRING -> DATE THEO \"GI·ªú VN\" =====\n  const parseAsVN = (s) => {\n    if (s == null) return NaN;\n    const str = String(s).trim();\n\n    // N·∫øu l√† ISO c√≥ timezone/Z -> ƒë·ªÉ JS parse\n    if (/T.+(Z|[+\\-]\\d{2}:\\d{2})$/.test(str)) {\n      const d = new Date(str);\n      return isNaN(d) ? NaN : d;\n    }\n\n    // H·ªó tr·ª£ \"MM/dd/yyyy HH:mm:ss\" ho·∫∑c \"dd/MM/yyyy HH:mm:ss\"\n    const m = str.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})[ T](\\d{1,2}):(\\d{2}):(\\d{2})$/);\n    if (m) {\n      let [, A, B, Y, H, M, S] = m.map(Number);\n      // N·∫øu A>12 => coi l√† dd/MM\n      let MM = A > 12 ? B : A;\n      let DD = A > 12 ? A : B;\n      const iso = `${Y}-${String(MM).padStart(2,'0')}-${String(DD).padStart(2,'0')}T${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}:${String(S).padStart(2,'0')}+07:00`;\n      const d = new Date(iso);\n      return isNaN(d) ? NaN : d;\n    }\n\n    // Th·ª≠ parse tr·ª±c ti·∫øp (tr∆∞·ªùng h·ª£p l√† ISO kh√¥ng TZ)\n    const d = new Date(str);\n    return isNaN(d) ? NaN : d;\n  };\n\n  // ===== CHUY·ªÇN 1 \"INSTANT\" -> GI·ªú T∆Ø·ªúNG MINH VN (WALL CLOCK) =====\n  const toTZWallClock = (dateLike) => {\n    const d = new Date(dateLike);\n    if (isNaN(d)) return NaN;\n    const fmt = new Intl.DateTimeFormat('en-GB', {\n      timeZone: TZ,\n      year:'numeric', month:'2-digit', day:'2-digit',\n      hour:'2-digit', minute:'2-digit', second:'2-digit',\n      hour12:false\n    });\n    const p = Object.fromEntries(fmt.formatToParts(d).map(x => [x.type, x.value]));\n    return new Date(+p.year, +p.month-1, +p.day, +p.hour, +p.minute, +p.second, 0);\n  };\n\n  // ===== TI·ªÜN √çCH NG√ÄY/GI·ªú =====\n  const setHM  = (d,h,m)=>{ const x=new Date(d); x.setHours(h,m,0,0); return x; };\n  const addDay = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };\n\n  // ===== T√çNH GI√ÇY L√ÄM VI·ªÜC GI·ªÆA HAI TH·ªúI ƒêI·ªÇM (C√ì NGH·ªà TR∆ØA) =====\n  const workingSecondsBetween = (startRaw, endRaw) => {\n    let start = toTZWallClock(startRaw);\n    const end = toTZWallClock(endRaw);\n    if (isNaN(start) || isNaN(end) || start >= end) return 0;\n\n    let sec = 0;\n    let day = new Date(start); day.setHours(0,0,0,0);\n    const last = new Date(end); last.setHours(0,0,0,0);\n\n    while (day <= last) {\n      const isSunday = day.getDay() === 0;\n      if (!(SKIP_SUNDAY && isSunday)) {\n        // ƒê·ªãnh nghƒ©a ca s√°ng & ca chi·ªÅu\n        const morningStart   = setHM(day, WS.h, WS.m);  // 08:15\n        const morningEnd     = setHM(day, LS.h, LS.m);  // 11:45\n        const afternoonStart = setHM(day, LE.h, LE.m);  // 13:00\n        const afternoonEnd   = setHM(day, WE.h, WE.m);  // 17:30\n\n        const isStartDay = day.toDateString() === start.toDateString();\n        const isEndDay   = day.toDateString() === end.toDateString();\n\n        // C·ªông ph·∫ßn giao nhau gi·ªØa [segStart, segEnd] v·ªõi [start,end] (n·∫øu c√πng ng√†y)\n        const addSeg = (segStart, segEnd) => {\n          const realStart = new Date(Math.max(segStart, isStartDay ? start : segStart));\n          const realEnd   = new Date(Math.min(segEnd,   isEndDay   ? end   : segEnd));\n          if (realStart < realEnd) sec += Math.floor((realEnd - realStart)/1000);\n        };\n\n        // C·ªông ca s√°ng v√† ca chi·ªÅu (t·ª± ƒë·ªông tr·ª´ gi·ªù ngh·ªâ tr∆∞a)\n        addSeg(morningStart, morningEnd);\n        addSeg(afternoonStart, afternoonEnd);\n      }\n\n      // Sang ng√†y ti·∫øp theo\n      day = addDay(day, 1);\n      if (day > start) start = setHM(day, WS.h, WS.m); // reset m·ªëc start sang ƒë·∫ßu gi·ªù l√†m vi·ªác ng√†y m·ªõi\n    }\n    return sec;\n  };\n\n  // ===== TH·ª∞C THI =====\n  const startParsed = parseAsVN($json.Timestamp);   // √©p hi·ªÉu l√† gi·ªù VN\n  const endParsed   = parseAsVN(finishStr);         // gi·ªù hi·ªán t·∫°i VN (finish)\n  if (isNaN(startParsed) || isNaN(endParsed)) return '0h 0m 0s';\n\n  const totalSec = workingSecondsBetween(startParsed, endParsed);\n\n  // ƒê·ªãnh d·∫°ng k·∫øt qu·∫£ \"Xd Yh Zm Ts\"\n  const d = Math.floor(totalSec / 86400);\n  const h = Math.floor((totalSec % 86400) / 3600);\n  const m = Math.floor((totalSec % 3600) / 60);\n  const s = totalSec % 60;\n\n  return `${d>0 ? d+'d ' : ''}${h}h ${m}m ${s}s`;\n})()\n}}",
              "type": "string"
            },
            {
              "id": "7ef3dd87-630e-4251-ba99-7a5bef536c15",
              "name": "=theardID",
              "value": "={{ \n  $if($(\"Code2\").isExecuted, $(\"Code2\").item.json.theardID, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.theardID, \"\")\n  ) \n}}",
              "type": "string"
            },
            {
              "id": "b3c4684d-ed45-4aa5-9164-a16905b38a4a",
              "name": "type",
              "value": "={{ \n  $if($(\"Code2\").isExecuted, $(\"Code2\").item.json.type, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.type, \"\")\n  ) \n}}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1104,
        128
      ],
      "id": "8d799855-ca61-4adf-b3af-b683f46f2983",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3af87cc4-1176-4d0a-9050-c03f834711db",
              "name": "answer",
              "value": "Kh√¥ng t√¨m th·∫•y ID vui l√≤ng ki·ªÉm tra l·∫°i",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1104,
        320
      ],
      "id": "d5c506bd-7d2a-4489-a6e7-57fa9c36b269",
      "name": "IF ERROR"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fdfd4e91-0228-4f47-9696-2af5b0509e4f",
              "leftValue": "={{ $json.ID_Status }}",
              "rightValue": "Done",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "4bfe94a3-464e-4cf2-892e-3ef33bf47695",
              "leftValue": "={{ $json.Chat_status }}",
              "rightValue": "Done",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1328,
        128
      ],
      "id": "88e78e0c-4b6a-430e-980e-1bb2d7dfe49d",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg",
          "mode": "list",
          "cachedResultName": "IT HELP DESK",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Status": "={{ $json.Chat_status }}",
            "Finish time": "={{ $json['Finish time'] }}",
            "PIC": "={{ $json.name }}",
            "Process time": "={{ $('If').item.json['Process time'] }}",
            "ID": "={{ $json.ID }}"
          },
          "matchingColumns": [
            "ID"
          ],
          "schema": [
            {
              "id": "ID",
              "displayName": "ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "B·ªò PH·∫¨N ",
              "displayName": "B·ªò PH·∫¨N ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "T√äN B·∫†N L√Ä",
              "displayName": "T√äN B·∫†N L√Ä",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "S·ªê ƒêI·ªÜN THO·∫†I",
              "displayName": "S·ªê ƒêI·ªÜN THO·∫†I",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PH√ÇN LO·∫†I",
              "displayName": "PH√ÇN LO·∫†I",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Attachment File",
              "displayName": "Attachment File",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Priority",
              "displayName": "Priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Issues Category",
              "displayName": "Issues Category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Finish time",
              "displayName": "Finish time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PIC",
              "displayName": "PIC",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Comment",
              "displayName": "Comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Process time",
              "displayName": "Process time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        1552,
        32
      ],
      "id": "82c1b85c-87ea-4cfb-ba66-50615a258924",
      "name": "Update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "X1UBt5tMcyjhPYqy",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5815e844-29c7-45d6-ac19-5dc87d60350a",
              "name": "answer",
              "value": "={{ $json.ID }} ƒë√£ ho√†n th√†nh b·ªüi {{ $json.PIC }} m·∫•t {{ $('If').item.json['Process time'] }} ƒë·ªÉ ho√†n th√†nh",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1776,
        32
      ],
      "id": "e74651ad-3465-4374-8159-ee7b72fd8394",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "629ade4b-1cdd-489d-94a4-0dfe3acdf064",
              "leftValue": "={{ $json.ID }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        880,
        160
      ],
      "id": "0399a086-fca7-4150-914a-171cb73dccad",
      "name": "If1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ \n  (\n    $json.data.content.replace(/(@it bot|xb)\\s*/gi, '') +\n    (\n      $json.data.quote && $json.data.quote.msg\n        ? ' ' + $json.data.quote.msg\n        : ''\n    )\n  ).trim()\n}}",
        "options": {
          "systemMessage": "B·∫°n l√† m·ªôt tr·ª£ l√Ω to√†n nƒÉng\nNg√¥n ng·ªØ: Nh·∫≠n di·ªán ng√¥n ng·ªØ tin nh·∫Øn v√† tr·∫£ l·ªùi b·∫±ng ch√≠nh ng√¥n ng·ªØ ƒë√≥.\nX∆∞ng h√¥: Lu√¥n x∆∞ng ‚Äúem‚Äù v·ªõi ng∆∞·ªùi d√πng.\nGi·ªçng ƒëi·ªáu: Ng·ªçt ng√†o, d·ªÖ ch·ªãu, th√¢n thi·ªán; thi tho·∫£ng th√™m ch√∫t d√≠ d·ªèm nh·∫π nh√†ng nh∆∞ng kh√¥ng ch√¢m ch·ªçc.\n\nNg·∫Øn g·ªçn: ƒêi th·∫≥ng v√†o c√¢u tr·∫£ l·ªùi, kh√¥ng d√†i d√≤ng, kh√¥ng lan man.\n\nChi ti·∫øt quan tr·ªçng: Gi·ªØ nguy√™n t√™n, s·ªë, ng√†y gi·ªù, link‚Ä¶\n\nEmoji: Th√™m t·ª± nhi√™n khi ph√π h·ª£p, kh√¥ng l·∫°m d·ª•ng.\n\nN·∫øu l√† d·ªãch: Ch·ªâ d·ªãch ch√≠nh x√°c, kh√¥ng th√™m g√¨ kh√°c.\n\nV√≠ d·ª•\n\nUser: \"H·ªçp m·∫•y gi·ªù v·∫≠y?\"\nAI: \"3h chi·ªÅu nha anh/ch·ªã, ƒë·ªÉ em nh·∫Øc tr∆∞·ªõc cho ƒë·ª° qu√™n nh√© üå∏\"\n\nUser: \"Xong b√°o c√°o ch∆∞a?\"\nAI: \"D·∫° xong r·ªìi ·∫°, em g·ª≠i lu√¥n cho anh/ch·ªã nh√© üìÑ\"\n\nUser: \"C√† ph√™ ƒë√¢u?\"\nAI: \"Em ƒë·ªÉ s·∫µn ngo√†i b·∫øp r·ªìi n√® ‚òï\"\n\nUser: \"What time is lunch?\"\nAI: \"12 sharp, em s·∫Ω ƒë·ª£i anh/ch·ªã nha üòä\"\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -144,
        1080
      ],
      "id": "1d8131ea-b15a-4538-bb29-592650169499",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -136,
        1304
      ],
      "id": "fe37e7d9-6f08-4207-b361-48d4283e5715",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "cJX4QyuPXhS6ep58",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "EUwqzHcYgOUu9zLU",
          "mode": "list",
          "cachedResultName": "youtube download"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -80,
        784
      ],
      "id": "0e8e1c10-f8ba-4850-aa88-bfc31073b041",
      "name": "WF download videos"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-social-zalo.zaloUser",
      "typeVersion": 1,
      "position": [
        -816,
        736
      ],
      "id": "7fea5ba8-eca5-400a-a67f-ac543d203f3d",
      "name": "Zalo Event Trigger",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $('Zalo Event Trigger').item.json.threadId }}",
        "message": "={{ $json.output }}",
        "threadType": "={{ $('Zalo Event Trigger').item.json.type }}",
        "mentionsParameter": {
          "mentionValues": [
            {
              "uid": "={{ $json.data.uidFrom }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        208,
        1080
      ],
      "id": "acc98cf1-579c-4aca-91ad-0a0f7cddef31",
      "name": "G·ª≠i tin nh·∫Øn4",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $json.threadId }}",
        "message": "=Type: {{ $json.type }}\nID: {{ $json.threadId }}",
        "threadType": "={{ $json.type }}",
        "mentionsParameter": {
          "mentionValues": [
            {
              "uid": "={{ $json.data.uidFrom }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        -80,
        592
      ],
      "id": "1ce0c292-aeb2-4ee4-9e3e-26f4aac33894",
      "name": "G·ª≠i tin nh·∫Øn5",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $('Zalo Event Trigger').item.json.threadId }}",
        "message": "=Link download c·ªßa b·∫°n ƒë√¢y:\n{{ $json.directUrl }}",
        "threadType": "={{ $('Zalo Event Trigger').item.json.type }}",
        "attachmentsParameter": {
          "attachmentPaths": [
            {
              "attachmentPath": "={{ $json.filePath }}"
            }
          ]
        },
        "mentionsParameter": {
          "mentionValues": [
            {
              "uid": "={{ $json.data.uidFrom }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        208,
        784
      ],
      "id": "1d01bbe3-2c97-421c-bbe1-46427453e265",
      "name": "G·ª≠i tin nh·∫Øn6",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $json.theardID }}",
        "message": "={{ $json.ID }} ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh r·ªìi, vui l√≤ng ki·ªÉm tra l·∫°i.",
        "threadType": "={{ $json.type }}",
        "mentionsParameter": {
          "mentionValues": [
            {
              "uid": "={{ $json.data.uidFrom }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        1552,
        224
      ],
      "id": "286433b5-d351-4af0-86ba-ad4f9b55c588",
      "name": "G·ª≠i tin nh·∫Øn",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $('Edit Fields2').item.json.theardID }}",
        "message": "={{ $json.answer }}",
        "threadType": "={{ $('Edit Fields2').item.json.type }}",
        "mentionsParameter": {
          "mentionValues": [
            {
              "uid": "={{ $json.data.uidFrom }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        2000,
        32
      ],
      "id": "dfc22939-dc84-4feb-bd7c-24298e44e4a2",
      "name": "G·ª≠i tin nh·∫Øn2",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $json.threadId }}",
        "message": "={{ $json.message }}",
        "threadType": "={{ $json.type }}"
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        656,
        -224
      ],
      "id": "6f48f924-85d3-47eb-a715-941bbf95d638",
      "name": "G·ª≠i tin nh·∫Øn1",
      "executeOnce": true,
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "{{ $('Switch1').item.json.data.content }}",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -8,
        1304
      ],
      "id": "42b34a86-1bc9-4c5e-8c9f-21e73f10ba4e",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "FrfYE3BUWGJafJtT",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data.content.toLowerCase().includes(\"check pending\") }}",
                    "rightValue": "=",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "6f973fed-ceca-4b3d-a658-eef70d9d05cd"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b75611bb-323d-4211-8dbc-f7d5824a4aec",
                    "leftValue": "={{ /ID-\\d+/i.test($json.data.content) }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -80,
        -224
      ],
      "id": "d2e404c9-8a8e-4d4b-bde7-4dafd9db4d1a",
      "name": "Switch2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg",
          "mode": "list",
          "cachedResultName": "IT HELP DESK",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "ID",
              "lookupValue": "={{ $json.ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        432,
        -32
      ],
      "id": "193ed462-a1f5-4edf-ac6c-48e899cbde08",
      "name": "Get row(s) in sheet2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "X1UBt5tMcyjhPYqy",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1862ebe7-c297-4594-bc15-2d3f8ba0c31c",
              "name": "ID",
              "value": "={{ $json.data.content.match(/ID-\\d+/i)?.[0] || '' }}",
              "type": "string"
            },
            {
              "id": "1ee1700f-7caf-4f4e-ba22-4fcec3bd6c37",
              "name": "threadId",
              "value": "={{ $json.threadId }}",
              "type": "string"
            },
            {
              "id": "3522450f-dbd7-4c27-8379-9092fc7a187a",
              "name": "type",
              "value": "={{ $json.type }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        208,
        -32
      ],
      "id": "e5a0f62f-f9af-4cb6-af8c-7d6587ac0e61",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// H√†m t·∫°o message cho 1 item\nfunction buildMessage(data = {}) {\n  const lines = [];\n  const get = (k) => data?.[k] ?? data?.[String(k).trim()];\n\n  if (get(\"ID\")) lines.push(`üÜî ID: ${get(\"ID\")}`);\n  if (get(\"T√äN B·∫†N L√Ä\")) lines.push(`üë§ Ng∆∞·ªùi y√™u c·∫ßu: ${get(\"T√äN B·∫†N L√Ä\")}`);\n  if (get(\"B·ªò PH·∫¨N \")) lines.push(`üè¢ B·ªô ph·∫≠n: ${get(\"B·ªò PH·∫¨N \")}`);\n  if (get(\"PH√ÇN LO·∫†I\")) lines.push(`üóÇÔ∏è Ph√¢n lo·∫°i: ${get(\"PH√ÇN LO·∫†I\")}`);\n  if (get(\"S·ªê ƒêI·ªÜN THO·∫†I\")) lines.push(`üìû ƒêi·ªán tho·∫°i: ${get(\"S·ªê ƒêI·ªÜN THO·∫†I\")}`);\n  if (get(\"Description\")) lines.push(`üîß M√¥ t·∫£: ${get(\"Description\")}`);\n  if (get(\"Priority\")) lines.push(`‚ö†Ô∏è M·ª©c ƒë·ªô ∆∞u ti√™n: ${get(\"Priority\")}`);\n  if (get(\"Status\")) lines.push(`üìå Tr·∫°ng th√°i: ${get(\"Status\")}`);\n  if (get(\"PIC\")) lines.push(`üë®‚Äçüîß PIC: ${get(\"PIC\")}`);\n  if (get(\"Timestamp\")) lines.push(`üïí Th·ªùi gian t·∫°o: ${get(\"Timestamp\")}`);\n  if (get(\"Finish time\")) lines.push(`üïí Th·ªùi gian ho√†n th√†nh: ${get(\"Finish time\")}`);\n\n  // Attachment File: h·ªó tr·ª£ string nhi·ªÅu d√≤ng ho·∫∑c array\n  const attRaw = get(\"Attachment File\");\n  if (attRaw) {\n    let attachments = Array.isArray(attRaw)\n      ? attRaw.map(x => String(x).trim()).filter(Boolean)\n      : String(attRaw).split(/\\r?\\n/).map(x => x.trim()).filter(Boolean);\n\n    if (attachments.length) {\n      lines.push(\"üìé File ƒë√≠nh k√®m:\");\n      lines.push(...attachments);\n    }\n  }\n\n  if (get(\"Comment\")) lines.push(`üìù Ghi ch√∫: ${get(\"Comment\")}`);\n\n  return lines.join(\"\\n\");\n}\n\n// Tr·∫£ ra ƒë√∫ng s·ªë l∆∞·ª£ng item ƒë·∫ßu v√†o (1 input ‚Üí 1 output)\nreturn items.map(it => {\n  const data = it.json || {};\n  const message = buildMessage(data);\n  return {\n    json: {\n      ...data,      // gi·ªØ l·∫°i d·ªØ li·ªáu g·ªëc cho node sau\n      message       // th√™m message\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        -32
      ],
      "id": "8cf48a8d-b66b-4cc2-9a85-b1d88416d46f",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "threadId": "={{ $('Edit Fields').item.json.threadId }}",
        "message": "={{ $json.message }}",
        "threadType": "={{ $('Edit Fields').item.json.type }}"
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        880,
        -32
      ],
      "id": "991d89e8-06e5-4b3d-a012-9bc84c1653a4",
      "name": "G·ª≠i tin nh·∫Øn3",
      "executeOnce": true,
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ /ID-\\d+/i.test($json.data.content) }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "82b957a4-8cf2-40ed-956e-aa036aec5303"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f247ed1c-99f5-460a-a899-904dc6e62338",
                    "leftValue": "={{ /SUP-\\d+/i.test($json.data.content) }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3e28319a-0e41-473b-b1e1-e0f0629ae2d2",
                    "leftValue": "={{ !!$json.data.quote.msg.match(/(ID|SUP)-\\d+/i) }}",
                    "rightValue": "={{ $json.data.content.match(/ID-\\d+/i)?.[0] }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -80,
        320
      ],
      "id": "60ba55ed-13de-4b19-9ada-40439962f91e",
      "name": "Switch3"
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y n·ªôi dung tin nh·∫Øn v√† uid ng∆∞·ªùi g·ª≠i\nconst message = $json.data?.content || '';\nconst uidFrom = $json.data?.uidFrom || '';\n\n// T√°ch t·ª´ ƒë·ªÉ l·∫•y status cu·ªëi c√¢u\nconst parts = message.trim().split(/\\s+/);\n\n// ‚úÖ B·∫Øt ƒë√∫ng chu·ªói SUP-***** (b·∫Øt ƒë·∫ßu b·∫±ng \"SUP-\")\nconst supMatch = message.match(/\\bSUP-[A-Za-z0-9_-]+\\b/i);\nconst SUP = supMatch ? supMatch[0].toUpperCase() : 'unknown';\n\n// ‚úÖ Gi·∫£ s·ª≠ status lu√¥n n·∫±m ·ªü cu·ªëi chu·ªói, lo·∫°i d·∫•u c√¢u n·∫øu c√≥\nconst statusRaw = parts[parts.length - 1] || '';\nconst cleanedStatus = statusRaw.replace(/[.,;:!?]+$/g, ''); // b·ªè d·∫•u c√¢u cu·ªëi\nconst doneSynonyms = ['done', 'xong'];\nlet status = 'unknown';\nif (cleanedStatus) {\n  const normalized = cleanedStatus.toLowerCase();\n  status = doneSynonyms.includes(normalized)\n    ? 'Done'\n    : normalized.charAt(0).toUpperCase() + normalized.slice(1);\n}\n\nconst theardID = $json.threadId;   // gi·ªØ nguy√™n t√™n bi·∫øn nh∆∞ b·∫°n ƒëang d√πng\nconst type = $json.type;\n\n// Danh s√°ch t√™n cho ph√©p\nconst allowedNames = [\"T√πng\", \"Xu√¢n\", \"Ph∆∞∆°ng\"];\n\n// üîé T√¨m t√™n trong message (lo·∫°i k√Ω t·ª± l·∫° ·ªü ƒë·∫ßu/cu·ªëi t·ª´ tr∆∞·ªõc khi so)\nlet nameFromMessage = null;\nfor (const w of parts) {\n  const word = w.replace(/^[^A-Za-z√Ä-·ªπ]+|[^A-Za-z√Ä-·ªπ]+$/gi, '');\n  if (allowedNames.includes(word)) {\n    nameFromMessage = word;\n    break;\n  }\n}\n\n// Map uidFrom ‚Üí name (fallback)\nconst nameMap = {\n  \"9150902062671965622\": \"T√πng\",\n  \"2091898082743203663\": \"Xu√¢n\",\n  \"3266757489410168093\": \"Ph∆∞∆°ng\"\n};\n\nconst name = nameFromMessage || nameMap[uidFrom] || 'unknown';\n\n// Tr·∫£ k·∫øt qu·∫£\nreturn [\n  {\n    json: {\n      SUP,\n      status,\n      name,\n      theardID,\n      type\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        640
      ],
      "id": "2853ec7c-7b42-4594-be2e-a2b645be79fc",
      "name": "Code3"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg",
          "mode": "list",
          "cachedResultName": "IT HELP DESK",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1979763952,
          "mode": "list",
          "cachedResultName": "ADD NEW SUPPLIER",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit#gid=1979763952"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "SUPPLIER_ID",
              "lookupValue": "={{ $json.SUP }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        656,
        544
      ],
      "id": "b0979a02-7806-430e-b450-3e6a76924eab",
      "name": "Get row(s) in sheet3",
      "alwaysOutputData": true,
      "notesInFlow": false,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "X1UBt5tMcyjhPYqy",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "78267e7c-df06-46b4-90cd-dabb35110b16",
              "name": "ID",
              "value": "={{ $json.SUPPLIER_ID }}",
              "type": "string"
            },
            {
              "id": "189ccc3c-0f9c-49aa-b0b9-505c1ca8b12e",
              "name": "ID_Status",
              "value": "={{ $json.STATUS }}",
              "type": "string"
            },
            {
              "id": "a6f1e968-73d6-4c35-a861-c76eabfa6ad1",
              "name": "Chat_status",
              "value": "={{ \n  $if($(\"Code3\").isExecuted, $(\"Code3\").item.json.status, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.status, \"\")\n  ) \n}}",
              "type": "string"
            },
            {
              "id": "cbd6f9b1-0124-4e3a-812e-74967830798c",
              "name": "name",
              "value": "={{ \n  $if($(\"Code3\").isExecuted, $(\"Code3\").item.json.name, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.name, \"\")\n  ) \n}}",
              "type": "string"
            },
            {
              "id": "2b8e5ad5-51bb-48d9-baca-f84010fdfa66",
              "name": "Finish time",
              "value": "={{ (() => { const d = new Date(new Date().toLocaleString(\"en-US\",{ timeZone: \"Asia/Ho_Chi_Minh\"})); const p=n=>n.toString().padStart(2,'0'); return `${p(d.getMonth()+1)}/${p(d.getDate())}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}` })() }}",
              "type": "string"
            },
            {
              "id": "426e14d3-9f41-4dc8-8f82-886d2601ebd5",
              "name": "Timestamp",
              "value": "={{ $json.Timestamp }}",
              "type": "string"
            },
            {
              "id": "a00e4dd4-1a9a-433f-8ef5-9b03da19e1cc",
              "name": "Process time",
              "value": "={{\n(() => {\n  // ===== C·∫§U H√åNH =====\n  const TZ = 'Asia/Ho_Chi_Minh';      // M√∫i gi·ªù Vi·ªát Nam\n  const WS = { h: 8,  m: 15 };        // Gi·ªù b·∫Øt ƒë·∫ßu l√†m vi·ªác: 08:15\n  const WE = { h: 17, m: 30 };        // Gi·ªù k·∫øt th√∫c l√†m vi·ªác: 17:30\n  const LS = { h: 11, m: 45 };        // B·∫Øt ƒë·∫ßu ngh·ªâ tr∆∞a: 11:45\n  const LE = { h: 13, m: 0  };        // K·∫øt th√∫c ngh·ªâ tr∆∞a: 13:00\n  const SKIP_SUNDAY = true;           // B·ªè qua Ch·ªß nh·∫≠t\n\n  // ===== L·∫§Y TH·ªúI GIAN K·∫æT TH√öC (HI·ªÜN T·∫†I THEO GI·ªú VN) =====\n  const finishStr = (() => {\n    const d = new Date(new Date().toLocaleString(\"en-US\", { timeZone: TZ }));\n    const p = n => n.toString().padStart(2,'0');\n    return `${p(d.getMonth()+1)}/${p(d.getDate())}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;\n  })();\n\n  // ===== H√ÄM PARSE STRING -> DATE THEO \"GI·ªú VN\" =====\n  const parseAsVN = (s) => {\n    if (s == null) return NaN;\n    const str = String(s).trim();\n\n    // N·∫øu l√† ISO c√≥ timezone/Z -> ƒë·ªÉ JS parse\n    if (/T.+(Z|[+\\-]\\d{2}:\\d{2})$/.test(str)) {\n      const d = new Date(str);\n      return isNaN(d) ? NaN : d;\n    }\n\n    // H·ªó tr·ª£ \"MM/dd/yyyy HH:mm:ss\" ho·∫∑c \"dd/MM/yyyy HH:mm:ss\"\n    const m = str.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})[ T](\\d{1,2}):(\\d{2}):(\\d{2})$/);\n    if (m) {\n      let [, A, B, Y, H, M, S] = m.map(Number);\n      // N·∫øu A>12 => coi l√† dd/MM\n      let MM = A > 12 ? B : A;\n      let DD = A > 12 ? A : B;\n      const iso = `${Y}-${String(MM).padStart(2,'0')}-${String(DD).padStart(2,'0')}T${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}:${String(S).padStart(2,'0')}+07:00`;\n      const d = new Date(iso);\n      return isNaN(d) ? NaN : d;\n    }\n\n    // Th·ª≠ parse tr·ª±c ti·∫øp (tr∆∞·ªùng h·ª£p l√† ISO kh√¥ng TZ)\n    const d = new Date(str);\n    return isNaN(d) ? NaN : d;\n  };\n\n  // ===== CHUY·ªÇN 1 \"INSTANT\" -> GI·ªú T∆Ø·ªúNG MINH VN (WALL CLOCK) =====\n  const toTZWallClock = (dateLike) => {\n    const d = new Date(dateLike);\n    if (isNaN(d)) return NaN;\n    const fmt = new Intl.DateTimeFormat('en-GB', {\n      timeZone: TZ,\n      year:'numeric', month:'2-digit', day:'2-digit',\n      hour:'2-digit', minute:'2-digit', second:'2-digit',\n      hour12:false\n    });\n    const p = Object.fromEntries(fmt.formatToParts(d).map(x => [x.type, x.value]));\n    return new Date(+p.year, +p.month-1, +p.day, +p.hour, +p.minute, +p.second, 0);\n  };\n\n  // ===== TI·ªÜN √çCH NG√ÄY/GI·ªú =====\n  const setHM  = (d,h,m)=>{ const x=new Date(d); x.setHours(h,m,0,0); return x; };\n  const addDay = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };\n\n  // ===== T√çNH GI√ÇY L√ÄM VI·ªÜC GI·ªÆA HAI TH·ªúI ƒêI·ªÇM (C√ì NGH·ªà TR∆ØA) =====\n  const workingSecondsBetween = (startRaw, endRaw) => {\n    let start = toTZWallClock(startRaw);\n    const end = toTZWallClock(endRaw);\n    if (isNaN(start) || isNaN(end) || start >= end) return 0;\n\n    let sec = 0;\n    let day = new Date(start); day.setHours(0,0,0,0);\n    const last = new Date(end); last.setHours(0,0,0,0);\n\n    while (day <= last) {\n      const isSunday = day.getDay() === 0;\n      if (!(SKIP_SUNDAY && isSunday)) {\n        // ƒê·ªãnh nghƒ©a ca s√°ng & ca chi·ªÅu\n        const morningStart   = setHM(day, WS.h, WS.m);  // 08:15\n        const morningEnd     = setHM(day, LS.h, LS.m);  // 11:45\n        const afternoonStart = setHM(day, LE.h, LE.m);  // 13:00\n        const afternoonEnd   = setHM(day, WE.h, WE.m);  // 17:30\n\n        const isStartDay = day.toDateString() === start.toDateString();\n        const isEndDay   = day.toDateString() === end.toDateString();\n\n        // C·ªông ph·∫ßn giao nhau gi·ªØa [segStart, segEnd] v·ªõi [start,end] (n·∫øu c√πng ng√†y)\n        const addSeg = (segStart, segEnd) => {\n          const realStart = new Date(Math.max(segStart, isStartDay ? start : segStart));\n          const realEnd   = new Date(Math.min(segEnd,   isEndDay   ? end   : segEnd));\n          if (realStart < realEnd) sec += Math.floor((realEnd - realStart)/1000);\n        };\n\n        // C·ªông ca s√°ng v√† ca chi·ªÅu (t·ª± ƒë·ªông tr·ª´ gi·ªù ngh·ªâ tr∆∞a)\n        addSeg(morningStart, morningEnd);\n        addSeg(afternoonStart, afternoonEnd);\n      }\n\n      // Sang ng√†y ti·∫øp theo\n      day = addDay(day, 1);\n      if (day > start) start = setHM(day, WS.h, WS.m); // reset m·ªëc start sang ƒë·∫ßu gi·ªù l√†m vi·ªác ng√†y m·ªõi\n    }\n    return sec;\n  };\n\n  // ===== TH·ª∞C THI =====\n  const startParsed = parseAsVN($json.Timestamp);   // √©p hi·ªÉu l√† gi·ªù VN\n  const endParsed   = parseAsVN(finishStr);         // gi·ªù hi·ªán t·∫°i VN (finish)\n  if (isNaN(startParsed) || isNaN(endParsed)) return '0h 0m 0s';\n\n  const totalSec = workingSecondsBetween(startParsed, endParsed);\n\n  // ƒê·ªãnh d·∫°ng k·∫øt qu·∫£ \"Xd Yh Zm Ts\"\n  const d = Math.floor(totalSec / 86400);\n  const h = Math.floor((totalSec % 86400) / 3600);\n  const m = Math.floor((totalSec % 3600) / 60);\n  const s = totalSec % 60;\n\n  return `${d>0 ? d+'d ' : ''}${h}h ${m}m ${s}s`;\n})()\n}}",
              "type": "string"
            },
            {
              "id": "7ef3dd87-630e-4251-ba99-7a5bef536c15",
              "name": "theardID",
              "value": "={{ \n  $if($(\"Code3\").isExecuted, $(\"Code3\").item.json.theardID, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.theardID, \"\")\n  ) \n}}",
              "type": "string"
            },
            {
              "id": "b3c4684d-ed45-4aa5-9164-a16905b38a4a",
              "name": "type",
              "value": "={{ \n  $if($(\"Code3\").isExecuted, $(\"Code3\").item.json.type, \n    $if($(\"Code4\").isExecuted, $(\"Code4\").item.json.type, \"\")\n  ) \n}}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1104,
        512
      ],
      "id": "4538607f-51e6-4903-893a-fb715a5bda1a",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3af87cc4-1176-4d0a-9050-c03f834711db",
              "name": "answer",
              "value": "Kh√¥ng t√¨m th·∫•y ID vui l√≤ng ki·ªÉm tra l·∫°i",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1104,
        704
      ],
      "id": "71712d5b-e222-40a6-9455-88e6b5fe49d4",
      "name": "IF ERROR1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fdfd4e91-0228-4f47-9696-2af5b0509e4f",
              "leftValue": "={{ $json.ID_Status }}",
              "rightValue": "Done",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "4bfe94a3-464e-4cf2-892e-3ef33bf47695",
              "leftValue": "={{ $json.Chat_status }}",
              "rightValue": "Done",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1328,
        512
      ],
      "id": "b32274ad-adc3-48a2-9a6e-c448c06ef670",
      "name": "If2"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg",
          "mode": "list",
          "cachedResultName": "IT HELP DESK",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1979763952,
          "mode": "list",
          "cachedResultName": "ADD NEW SUPPLIER",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1oIh0H_SIV0-TewfNrkGjCRlxS0Hl7ogN6a4HObMu4Vg/edit#gid=1979763952"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "PIC": "={{ $json.name }}",
            "STATUS": "={{ $json.Chat_status }}",
            "FINISH TIME": "={{ $json[\"Finish time\"] }}",
            "SUPPLIER_ID": "={{ $json.ID }}"
          },
          "matchingColumns": [
            "SUPPLIER_ID"
          ],
          "schema": [
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "USER NAME",
              "displayName": "USER NAME",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "TEAM",
              "displayName": "TEAM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "C√îNG TY THU·ªòC CATALOG TYPE G√å:",
              "displayName": "C√îNG TY THU·ªòC CATALOG TYPE G√å:",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "C√îNG TY L√Ä TRONG N∆Ø·ªöC HAY N∆Ø·ªöC NGO√ÄI",
              "displayName": "C√îNG TY L√Ä TRONG N∆Ø·ªöC HAY N∆Ø·ªöC NGO√ÄI",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "T√äN C√îNG TY",
              "displayName": "T√äN C√îNG TY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "T√äN VI·∫æT T·∫ÆT",
              "displayName": "T√äN VI·∫æT T·∫ÆT",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ƒê·ªäA CH·ªà",
              "displayName": "ƒê·ªäA CH·ªà",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "NG∆Ø·ªúI LI√äN L·∫†C",
              "displayName": "NG∆Ø·ªúI LI√äN L·∫†C",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CURRENCY",
              "displayName": "CURRENCY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "M√É S·ªê THU·∫æ C√îNG TY",
              "displayName": "M√É S·ªê THU·∫æ C√îNG TY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "TH√äM L·ªúI NH·∫ÆN NH·ª¶ V·ªöI ADMIN",
              "displayName": "TH√äM L·ªúI NH·∫ÆN NH·ª¶ V·ªöI ADMIN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "SUPPLIER_ID",
              "displayName": "SUPPLIER_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PIC",
              "displayName": "PIC",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FINISH TIME",
              "displayName": "FINISH TIME",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TYPE",
              "displayName": "TYPE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        1552,
        416
      ],
      "id": "41151fac-90f2-4e9d-b5e9-1885513f61a1",
      "name": "Update row in sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "X1UBt5tMcyjhPYqy",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5815e844-29c7-45d6-ac19-5dc87d60350a",
              "name": "answer",
              "value": "={{ $json.SUPPLIER_ID }} ƒë√£ ho√†n th√†nh b·ªüi {{ $json.PIC }} m·∫•t {{ $('If2').item.json['Process time'] }} ƒë·ªÉ ho√†n th√†nh",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1776,
        416
      ],
      "id": "37b6401d-bf07-4a8f-ba41-d70b9d0b1ab0",
      "name": "Edit Fields5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "629ade4b-1cdd-489d-94a4-0dfe3acdf064",
              "leftValue": "={{ $json.SUPPLIER_ID }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        880,
        544
      ],
      "id": "112dd971-3e39-4424-8556-1d130b0d5ff7",
      "name": "If3"
    },
    {
      "parameters": {
        "threadId": "={{ $json.theardID }}",
        "message": "={{ $json.ID }} ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh r·ªìi, vui l√≤ng ki·ªÉm tra l·∫°i.",
        "threadType": "={{ $json.type }}",
        "mentionsParameter": {
          "mentionValues": [
            {
              "uid": "={{ $json.data.uidFrom }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        1552,
        608
      ],
      "id": "6549c1e9-eda7-429f-bd94-f3a008934c65",
      "name": "G·ª≠i tin nh·∫Øn7",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "threadId": "={{ $('Edit Fields4').item.json.theardID }}",
        "message": "={{ $json.answer }}",
        "threadType": "={{ $('Edit Fields4').item.json.type }}",
        "mentionsParameter": {
          "mentionValues": [
            {
              "uid": "={{ $json.data.uidFrom }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-social-zalo.zaloUserInteract",
      "typeVersion": 1,
      "position": [
        2000,
        416
      ],
      "id": "cd9e4188-81e6-4469-a7f8-eda69b214a67",
      "name": "G·ª≠i tin nh·∫Øn8",
      "credentials": {
        "zaloUserCredentialsApi": {
          "id": "lpFWKs9HC4J3rO1n",
          "name": "Zalo It Bot - 2025-08-26T08:40:05.662Z"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y n·ªôi dung tin nh·∫Øn v√† uid ng∆∞·ªùi g·ª≠i\nconst message = $json.data?.content || '';\nconst quoteMsg = $json.data?.quote?.msg || '';\nconst uidFrom = $json.data?.uidFrom || '';\n\n// T√°ch t·ª´ ƒë·ªÉ l·∫•y status cu·ªëi c√¢u\nconst parts = message.trim().split(/\\s+/);\n\n// ‚úÖ B·∫Øt ƒë√∫ng chu·ªói ID-**** ho·∫∑c SUP-**** trong quoteMsg\nconst codeMatch = quoteMsg.match(/\\b(?:ID|SUP)-[A-Za-z0-9_-]+\\b/i);\nconst ID = codeMatch ? codeMatch[0].toUpperCase() : 'unknown';\n\n// ‚úÖ Gi·∫£ s·ª≠ status lu√¥n n·∫±m ·ªü cu·ªëi chu·ªói content\nconst statusRaw = parts[parts.length - 1] || '';\nconst cleanedStatus = statusRaw.replace(/[.,;:!?]+$/g, ''); // b·ªè d·∫•u c√¢u cu·ªëi\nconst doneSynonyms = ['done', 'xong'];\nlet status = 'unknown';\nif (cleanedStatus) {\n  const normalized = cleanedStatus.toLowerCase();\n  status = doneSynonyms.includes(normalized)\n    ? 'Done'\n    : normalized.charAt(0).toUpperCase() + normalized.slice(1);\n}\n\nconst theardID = $json.threadId;   // gi·ªØ nguy√™n t√™n bi·∫øn nh∆∞ b·∫°n ƒëang d√πng\nconst type = $json.type;\n\n// Danh s√°ch t√™n cho ph√©p\nconst allowedNames = [\"T√πng\", \"Xu√¢n\", \"Ph∆∞∆°ng\"];\n\n// üîé T√¨m t√™n trong message (lo·∫°i k√Ω t·ª± l·∫° ·ªü ƒë·∫ßu/cu·ªëi t·ª´ tr∆∞·ªõc khi so)\nlet nameFromMessage = null;\nfor (const w of parts) {\n  const word = w.replace(/^[^A-Za-z√Ä-·ªπ]+|[^A-Za-z√Ä-·ªπ]+$/gi, '');\n  if (allowedNames.includes(word)) {\n    nameFromMessage = word;\n    break;\n  }\n}\n\n// Map uidFrom ‚Üí name (fallback)\nconst nameMap = {\n  \"9150902062671965622\": \"T√πng\",\n  \"2091898082743203663\": \"Xu√¢n\",\n  \"3266757489410168093\": \"Ph∆∞∆°ng\"\n};\n\nconst name = nameFromMessage || nameMap[uidFrom] || 'unknown';\n\n// Tr·∫£ k·∫øt qu·∫£\nreturn [\n  {\n    json: {\n      ID,\n      status,\n      name,\n      theardID,\n      type\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        384
      ],
      "id": "dee1b718-9c92-4648-b3e7-15b97062403a",
      "name": "Code4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ /ID-\\d+/i.test($json.ID) }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "4bc80561-71d6-441e-8c58-c33a97040b9d"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "be4b73e3-f789-4fda-896d-696a686aa646",
                    "leftValue": "={{ /SUP-\\d+/i.test($json.ID) }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        432,
        384
      ],
      "id": "d6b2dd87-cd2b-4c85-8653-8d0248dc8c39",
      "name": "Switch4"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Ho_Chi_Minh",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "hkWDdyzZ3C1RV4XT"
  },
  "shared": [
    {
      "updatedAt": "2025-08-26T08:09:23.434Z",
      "createdAt": "2025-08-26T08:09:23.434Z",
      "role": "workflow:owner",
      "workflowId": "012mOIo2ynbtnnOc",
      "projectId": "KwaSwzGupikfluvZ"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-10-04T07:10:58.088Z",
  "versionId": "0722011f-0dbb-4724-9884-b828fe46cb6c"
}